## 性能设计知识
### 设计前提
#### 预期系统在业务场景下运行对性能有要求时才进行设计，防止过度设计。
### 设计目的
- #### 规划一个系统，使得运行在一定资源中，且满足功能完整性和向后扩展性的条件下，系统吞吐量最大。设R为系统运行资源，F为需求功能，E为演进扩展性，P为吞吐量，则P表示为：
                        P=p(M)，M<{R,F,E}
            其中M表示设计途径的集合，M满足R、F、E三个条件
  #### 则设计目的为使P最大化。
  #### 实际系统中，R一般包括机器CPU、内存、磁盘、网络、依赖系统等，F一般包括功能覆盖量和功能完整性，E指受需求或其他影响系统演进难易程度，P一般包括系统吞吐量QPS，响应时间RT、并发数等。
### 设计方向
- #### 并发数：系统同时处理的事务数量，常见方式有多线程、系统拆分、负载均衡、运行环境（JVM）优化等
- #### 响应时间：缓存、数据库优化、文件系统优化、代码性能、运算分离、环境优化等
### 常见设计点
- > #### 缓存使用：这里的缓存按所处层级分为三种：
    - ##### 数据库与服务层间的缓存：在系统对数据库中一部分数据高频率查询，并且数据修改操作较少时可以使用，将这部分数据放入缓存中。主要提高查询响应时间和缓解数据库压力，注意点是数据修改导致的缓存数据和库中数据的一致性。
    - ##### 服务层的缓存：主要针对两类数据，一类是对系统运行中产生的非业务强关联但和服务层交互频率高的数据，另一类是系统启动需要初始化加载的数据。服务层直接和缓存交互，提高响应速度，针对集群或分布式部署时，也可以解决数据一致性。
    - ##### web层和服务层间的缓存：对页面经常访问的页面数据和静态数据可以直接放web缓存或者第三方缓存，比如CDN等；对要经过服务端处理但变动频率小的数据可以放web层和服务层中间的缓存层中，比如Nginx缓存等。这里缓存主要提高页面的响应速度。
- > #### 多线程：当系统硬件：磁盘、网络、内存、CPU等都未达到瓶颈，可以增加系统线程数提高系统处理能力，注意点是系统创建和销毁线程有较大资源消耗，一般用线程池让系统管理线程；可能导致线程安全和数据一致性问题及锁的问题等。
- > #### 数据库优化：根据系统需要持久化数据类型和数据用途，选择正确的关系型数据库还是noSQL数据库，甚至搜索引擎；根据是数据冷热程度和数据量大小选择是否要分库分表；在确定后根据读写数据优化方式：索引创建、字段类型正确选择、查询语句优化、变一次大量数据读写为多次较少量数据读写、正确使用数据库函数以及正确配置数据库相关参数。
- > #### 负载均衡：受硬件和其他限制，系统纵向不能无限纵向扩展，当纵向扩展带来提升受限时，可以对系统横向扩展，集群部署系统，增加系统处理能力。但由此也带来其他工作：选择合适的均衡算法，防止个别系统空闲个别系统请求堆积；Session管理问题；数据一致问题等。
- > #### 合理使用文件系统：在系统运行中，可能涉及到文件读写，可能是对本机操作，也可能是远程文件系统，合理选择文件存放位置和文件系统类型及文件传输协议对系统处理性能也很重要，比如是否支持断点续传、是否易受网络影响、如果是本机对内存使用怎么样等。
- > #### 应用层优化：主要包括代码性能优化和MVC三层职能划分：
    - ##### 前者主要指不合理的代码写法：多层循环、循环查询数据库、一次从数据库查询大量数据、不合理的数据结构和算法、不必要的锁等待和线程等待、不必要的单个线程创建、static变量和threadLocal导致的内存泄漏、过多的日志打印等等。
    - ##### 层级职能划分主要有：View层未合理使用缓存，重复请求控制层；合理的运算分离等
- > #### JVM调优：这部分主要指服务端Java程序，包括：堆大小、年轻代大小、栈空间大小、GC器选择和配置等。
### 设计难点
- #### 对一个系统的性能设计最好在系统开始初期就规划好，防止中期或后期才考虑性能时可能带来架构调整、代码重构等问题。但是很多系统都是演进式的，演进方向和推动演进的因素很多，包括用户量增加、业务修改、业务扩展、依赖系统变动、依赖中间件许可证变更等，在初期不容易甚至不可能对项目后期发展准确判断。
  #### 所以在做性能设计（当然项目总体架构设计也是一样）时，不只要了解所涉及到的业务场景、数据量、业务功能点，以及相关技术、框架，最好还要能根据现有业务需求形势和技术形势，最大限度的预期到系统演进方向，减少演进中系统的修改工作量。
 ### 成果
- 协同平台数据处理系统改造
 

