# 设备网关
## 概述
设备网关主要连接车场各设备（目前有盒子），接入平台所需的车辆进出数据、停车报警数据、车位检测数据、设备报警数据，并提供IPC视频拉流、IPC泊位划线、设备升级等功能。
## 设备连接
设备网关集成设备SDK，设备采用主动注册方式接入到平台，触发平台执行设备登录操作，设备登录所需验证信息由基础服务提供。当设备连接成功后，调用基础服务接口更新设备在离线状态，
SDK初始化时，注册断连回调函数，断开连接时，执行回调逻辑通知基础服务更新设备在离线状态。
## 事件
### 车辆进出事件
1. 事件获取
> 登录设备后，订阅盒子对应通道设备车位有无车事件，对应通道IPC事件发生时，通过回调函数接入数据至设备网关
2. 事件处理
> 从事件结构体解析对应数据，封装为平台可识别进出场对象，通过消息同步至其他服务。
### 车位检测事件
1. 事件获取
> 登录设备后，订阅盒子车位检测事件，设备执行检测并处理后，通过回调函数接入数据至设备网关
2. 事件处理
> 从事件结构体解析对应数据，封装为平台可识别车位检测对象，通过消息同步至其他服务。
### 设备报警事件
1. 事件获取
2. 解析封装事件后，通过kafka消息同步数据中报警中心
### 设备升级
#### 盒子升级
1. 升级包判重
2. 设置升级回调函数
3. 添加升级事件至队列
4. 执行升级
5. 根据回调状态刷新升级队列
6. 更新基础服务设备升级状态
7. 触发升级队列重新检测可升级事件并执行升级
#### IPC升级
1. 订阅IPC升级事件和回调函数
2. 升级包判重
3. 设置盒子推送升级包回调函数
4. 添加升级事件至队列
5. 执行升级
6. 根据盒子推送回调函数和相机升级回调函数回调状态刷新升级队列
7. 更新基础服务设备升级状态
8. 触发升级队列重新检测可升级事件并执行升级
### IPC泊位划线
#### 划线获取
1. 和划线页面创建websocket连接
2. 解析、计算点位、封装
3. 通过websocket发送至划线页面
#### 划线下发
1. 检验、计算点位、封装
2. 通过SDK接口下发至IPC
### IPC拉流
1. 和预览页面创建websocket连接
2. 订阅实时视频事件，设置回调函数
3. 解析视频流
4. 封装为视频流帧
5. 通过websocket发送视频流帧至预览页面
